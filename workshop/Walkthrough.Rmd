---
title: "Intro to R"
author: "Mike Spencer"
date: "2nd July 2019"
output: 
  github_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro

*This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.*

We're using <https://rstudio.cloud/> to host the workshop. The conditions of use mean we can only use this for educational purposes. It's a great resource for teaching, but is underpowered for most analysis. The big advantage is you can access RStudio through a web browser without the need to install anything!

The dataset you'll be working with today is the developer survey from Stackoverflow.
You can download it from <https://insights.stackoverflow.com/survey>.


## Help!

... and further resources

* `?Function`
* <http://edinbr.org/> your local user group
* <https://ourcodingclub.github.io/> coding club
* <http://www.bioss.ac.uk/training.html> BIOSS training courses
* <https://twitter.com/hashtag/rstats> on twitter!
* <https://www.tidyverse.org/> help guides
* <http://swcarpentry.github.io/r-novice-inflammation>
* <https://datacarpentry.org/R-ecology-lesson/> or <https://datacarpentry.org/r-socialsci/>
* <https://www.rstudio.com/resources/cheatsheets/>
* <https://www.coursera.org/learn/r-programming?>
* <https://r4ds.had.co.nz/>
* <http://dx.doi.org/10.18637/jss.v059.i10> 131256 downloads for tidy data!
* <https://bitbucket.org/sruclees/help/wiki/Home> SRUC REES data wiki
* SRUC R user group: <https://teams.microsoft.com/l/team/19%3a4492dd8b6fe24989a599ac8889dba374%40thread.skype/conversations?groupId=720f4eb2-1f80-4943-afa7-89f24b8b97c6&tenantId=c8542d98-e64c-446e-b8d5-0c98ffe56526>


## Language tips

* functions end in ()
* `?` before a function name for help
* objects are plain text
* %>% sends output to next function
* Wrap strings in "" or ''
* Separate arguments in function with a `,`
* Use formatting to make code easier to read


## Packages

```{r packages}
#install.packages("tidyverse")
library(tidyverse)
```


## Data

### Read

```{r data}
df = read_csv("../data/survey_results_public_UK.csv")
schema = read_csv("../data/survey_results_schema.csv")

?read_csv
```


### Explore

* See the `Environment` pane.
* What did R return after each dataset was read?

```{r explore}
schema
glimpse(df)
summary(df)
# View(df)
colnames(df)
```


## Building blocks

### Select columns

```{r select}
df %>% 
   select(Employment, Ethnicity)

df %>% 
   select(-Respondent)
```


### Filter rows

```{r filter}
df %>% 
   filter(Employment == "Not employed, but looking for work")

df %>% 
   filter(Employment != "Not employed, but looking for work")
```


### Count observations

```{r count}
df %>% 
   count(Employment)

df %>% 
   count(Employment, Ethnicity)

df %>% 
   drop_na() %>% 
   count(Employment, Ethnicity)
```


### Sort data

```{r sort}
df %>% 
   count(Employment) %>% 
   arrange(desc(n))
```


### Add/change variables

```{r mutate}
df %>% 
   select(WorkWeekHrs) %>% 
   mutate(work_week = WorkWeekHrs / (24 * 7))
```


### Summarise

Similar to mutate, but collapses results

```{r summarise}
df %>% 
   group_by(EdLevel) %>% 
   summarise(hrs = mean(WorkWeekHrs))

df %>% 
   drop_na(EdLevel, WorkWeekHrs) %>% 
   group_by(EdLevel) %>% 
   summarise(hrs = mean(WorkWeekHrs))

df %>% 
   drop_na(EdLevel, WorkWeekHrs) %>% 
   group_by(EdLevel) %>% 
   summarise(hrs = mean(WorkWeekHrs)) %>% 
   arrange(desc(hrs))

df %>% 
   drop_na(EdLevel, WorkWeekHrs) %>% 
   group_by(EdLevel) %>% 
   summarise(hrs = mean(WorkWeekHrs),
             n = n()) %>% 
   arrange(desc(hrs))

df %>% 
   drop_na(EdLevel, WorkWeekHrs) %>% 
   group_by(EdLevel) %>% 
   summarise(hrs = mean(WorkWeekHrs),
             n = n()) %>% 
   arrange(desc(hrs)) %>% 
   filter(n > 10)
```

Could do that fancy Bayes trick here...
<http://store.varianceexplained.org/>


## Plotting

Reiterate the tidyverse pages: <https://ggplot2.tidyverse.org/reference/>

```{r ggplot}
ggplot(df, aes(EdLevel)) +
   geom_bar()

df %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar()

df %>% 
   drop_na(EdLevel) %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar() +
   coord_flip()

df %>% 
   drop_na(EdLevel) %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar() +
   coord_flip() +
   labs(title = "Survey respondents",
        x = "",
        y = "Respondents")

df %>% 
   drop_na(EdLevel) %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4),
          EdLevel = fct_infreq(EdLevel)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar() +
   coord_flip() +
   labs(title = "Survey respondents",
        x = "",
        y = "Respondents")

df %>% 
   drop_na(EdLevel) %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4),
          EdLevel = fct_infreq(EdLevel)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar(fill = "#75ab42") +
   coord_flip() +
   labs(title = "Survey respondents education",
        x = "",
        y = "Respondents") +
   theme_light()

df %>% 
   drop_na(EdLevel) %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4),
          EdLevel = str_wrap(EdLevel, width = 60),
          EdLevel = fct_infreq(EdLevel)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar(fill = "#75ab42") +
   coord_flip() +
   labs(title = "Survey respondents education",
        x = "",
        y = "Respondents") +
   theme_light()
```


## Colour

Try out <http://colorbrewer2.org/> to find suitable palettes.

```{r colours}
df %>% 
   drop_na(EdLevel, WorkLoc) %>% 
   mutate(EdLevel = fct_lump(EdLevel, 4),
          EdLevel = str_wrap(EdLevel, width = 40),
          EdLevel = fct_infreq(EdLevel)) %>% 
   ggplot(aes(EdLevel, fill = str_wrap(WorkLoc, width = 20))) +
   geom_bar() +
   scale_fill_brewer(type = "qual", palette = "Dark2") +
   coord_flip() +
   labs(title = "Survey respondents education",
        x = "",
        y = "Respondents",
        fill = "") +
   theme_light()
```


## Functions

```{r function}
plot_function = function(i){
   df %>% 
      rename_(temp = i) %>% 
      drop_na(temp) %>% 
      ggplot(aes(temp)) +
      geom_bar() +
      coord_flip() +
      labs(title = schema %>% 
           filter(Column == i) %>% 
           select(QuestionText) %>% 
           str_wrap(width = 60) ,
           x = "",
           y = "Respondents") +
      theme_light()
}

plot_function("WorkLoc")
```


## Models

Very quickly!

```{r models}
x = df %>% 
   mutate(YearsCode = as.numeric(YearsCode)) %>% 
   select(YearsCode, CompTotal, CompFreq) %>% 
   filter(CompFreq == "Yearly") %>% 
   drop_na()

par(mfrow = c(2, 2))
lm(CompTotal ~ YearsCode, data = x) %>% 
   plot()
par(mfrow = c(1, 1))

ggplot(x, aes(YearsCode, CompTotal)) +
   geom_point() +
   stat_smooth(method = "lm") +
   coord_cartesian(ylim = c(0, 150000))
```


## Question

**Use your new skills to create a plot or table of something in the survey.**

**Use the export button on files to get your script.**


## Advanced

Here we can put it all together, with a little more magic to establish a research question.

```{r question, fig.width=10, fig.height=8}
# Split out languages worked with
x = df %>% 
   select(Respondent, LanguageWorkedWith)

# Make Languages into a tidy column
x = lapply(1:nrow(x), function(i){
   y = str_split(x[i, 2], ";") %>% 
      unlist()
   tibble(Respondent = x$Respondent[i],
          Languages = y)
})

# See also unnest_tokens

# Convert list into a data frame (tibble)
x = do.call("rbind.data.frame", x) %>% 
   filter(Languages == "R")

df %>% 
   inner_join(x) %>% 
   mutate(EdLevel = replace_na(EdLevel, "Unanswered"),
          EdLevel = str_wrap(EdLevel, width=40),
          EdLevel = fct_infreq(EdLevel)) %>% 
   ggplot(aes(EdLevel)) +
   geom_bar() +
   coord_flip() +
   labs(title = schema %>% 
           filter(Column == "EdLevel") %>% 
           select(QuestionText) %>% 
           str_wrap(width = 60),
        subtitle = "For respondents who work with R",
        x = "",
        y = "Respondents") +
   facet_wrap(~str_wrap(MainBranch, width=40))
```

R looks like it could be popular with researchers (all those people writing code who don't consider themselves developers), can we explore this and visualise an argument?

```{r answer}

```




[![Creative Commons License](https://i.creativecommons.org/l/by/4.0/88x31.png)](http://creativecommons.org/licenses/by/4.0/)
This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).
